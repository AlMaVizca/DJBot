---
- hosts: localhost
  gather_facts: yes
  tasks:
    - setup:
        filter: "ansible_*"
      tags:
        - build
        - restart
        
    - name: requirements
      pip:
        name: docker-py
        state: present
      become: yes
      when: ansible_distribution == "Debian"
      tags:
        - build

        
    - name: requirements
      pacman:
        name: python2-docker-py
        state: present
      become: yes
      when: ansible_distribution == "Archlinux"      
      tags:
        - build


    - name: Remove old container
      docker:
        name: djbot
        image: "{{ ansible_user_id }}/djbot"
        state: absent
      ignore_errors: yes        
      tags:
        - build
        - restart


    - name: create new image
      docker_image:
        path: "{{ ansible_user_dir}}/Repositories/djbot/src"
        name: "{{ ansible_user_id }}/djbot"
        state: present
      tags:
        - build

    - name: create containers
      docker:
        name: djbot
        image: "{{ ansible_user_id }}/djbot"
        state: started
        restart_policy: always
        volumes:
          - "{{ ansible_user_dir }}/Repositories/djbot/src:/usr/src/app"
          - "{{ ansible_user_dir }}/Repositories/djbot/keys:/root/.ssh/"
        env:
          MODE: "dev"
          VIRTUAL_HOST: "dev.djbot.local"
      tags:
        - build
        - restart
